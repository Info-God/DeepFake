{% extends "base.html" %}

{% block title %}Detect Deepfakes - Full Analysis{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1><i class="fas fa-search"></i> Deepfake Detection Analysis</h1>
        <p>Upload a video for comprehensive AI analysis and blockchain verification</p>
    </div>
</div>

<div class="container">
    <div class="upload-container">
        <div class="upload-card">
            <div class="upload-header">
                <div class="upload-icon">
                    <i class="fas fa-video"></i>
                </div>
                <h2>Upload Video for Full Analysis</h2>
                <p>AI Detection + Blockchain Verification + Detailed Report</p>
            </div>
            
            <div class="upload-body">
                <form action="{{ url_for('upload_video') }}" method="post" enctype="multipart/form-data" class="upload-form" id="uploadForm">
                    <!-- File Upload Area -->
                    <div class="file-upload-area" id="dropArea">
                        <input type="file" name="video" id="fileInput" accept="video/*" required hidden>
                        
                        <div class="upload-placeholder">
                            <div class="placeholder-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h3>Drag & Drop Video File</h3>
                            <p>or click to browse</p>
                            <p class="file-types">Supported: MP4, AVI, MOV, MKV, WEBM</p>
                            <p class="file-limit">Max size: 500MB</p>
                        </div>
                        
                        <div class="file-preview" id="filePreview" style="display: none;">
                            <div class="preview-icon">
                                <i class="fas fa-file-video"></i>
                            </div>
                            <div class="preview-info">
                                <h4 id="fileName">File Name</h4>
                                <p id="fileSize">File Size</p>
                                <button type="button" class="btn-remove" id="removeFile">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Options -->
                    <div class="upload-options">
                        <h3><i class="fas fa-cog"></i> Analysis Options</h3>
                        
                        <div class="option-group">
                            <label class="option-item">
                                <input type="checkbox" name="generate_report" checked>
                                <span class="option-checkbox"></span>
                                <span class="option-text">Generate Detailed PDF Report</span>
                            </label>
                            
                            <label class="option-item">
                                <input type="checkbox" name="notify_complete" checked>
                                <span class="option-checkbox"></span>
                                <span class="option-text">Show detailed results page</span>
                            </label>
                            
                            <label class="option-item">
                                <input type="checkbox" name="store_session">
                                <span class="option-checkbox"></span>
                                <span class="option-text">Keep results in session</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Analysis Information -->
                    <div class="analysis-info">
                        <h3><i class="fas fa-info-circle"></i> What happens next?</h3>
                        <div class="info-steps">
                            <div class="info-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>AI Analysis</h4>
                                    <p>Video frames are extracted and analyzed by our EfficientNet model</p>
                                </div>
                            </div>
                            <div class="info-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>Blockchain Verification</h4>
                                    <p>SHA-256 hash is generated and checked against Ethereum blockchain</p>
                                </div>
                            </div>
                            <div class="info-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>Results & Report</h4>
                                    <p>Get detailed analysis results and optional PDF report</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="upload-action">
                        <button type="submit" class="btn-primary btn-large" id="submitBtn">
                            <i class="fas fa-play"></i> Start Analysis
                        </button>
                        <p class="upload-note">
                            <i class="fas fa-clock"></i> Analysis typically takes 1-2 minutes depending on video length
                        </p>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Side Information -->
        <div class="side-info">
            <div class="info-card">
                <h3><i class="fas fa-robot"></i> AI Detection Technology</h3>
                <p>Our system uses EfficientNet-B0, a state-of-the-art convolutional neural network trained to detect subtle manipulation patterns in videos.</p>
                <ul>
                    <li>Frame-by-frame analysis</li>
                    <li>Facial feature detection</li>
                    <li>Temporal consistency checking</li>
                    <li>95%+ accuracy rate</li>
                </ul>
            </div>
            
            <div class="info-card">
                <h3><i class="fas fa-link"></i> Blockchain Verification</h3>
                <p>Every video generates a unique SHA-256 hash that can be registered on the Ethereum blockchain for permanent verification.</p>
                <ul>
                    <li>Immutable records</li>
                    <li>Timestamp verification</li>
                    <li>Ownership tracking</li>
                    <li>Public verification</li>
                </ul>
            </div>
            
            <div class="info-card">
                <h3><i class="fas fa-shield-alt"></i> Use Cases</h3>
                <p>This technology is essential for:</p>
                <ul>
                    <li>Journalism & News Verification</li>
                    <li>Legal Evidence Authentication</li>
                    <li>Social Media Content Moderation</li>
                    <li>Corporate Communications</li>
                    <li>Enter Industry Content Protection</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Upload Interaction -->
<script>
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFile = document.getElementById('removeFile');
    const submitBtn = document.getElementById('submitBtn');
    
    // Click to browse
    dropArea.addEventListener('click', () => fileInput.click());
    
    // File selection
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            updateFilePreview(file);
        }
    });
    
    // Drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropArea.classList.add('highlight');
    }
    
    function unhighlight() {
        dropArea.classList.remove('highlight');
    }
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            fileInput.files = files;
            updateFilePreview(files[0]);
        }
    }
    
    function updateFilePreview(file) {
        // Validate file type
        const validTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-matroska', 'video/webm'];
        if (!validTypes.includes(file.type)) {
            alert('Please upload a valid video file (MP4, AVI, MOV, MKV, WEBM)');
            return;
        }
        
        // Validate file size (500MB limit)
        if (file.size > 500 * 1024 * 1024) {
            alert('File size exceeds 500MB limit');
            return;
        }
        
        // Update preview
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        filePreview.style.display = 'flex';
        dropArea.querySelector('.upload-placeholder').style.display = 'none';
        
        // Enable submit button
        submitBtn.disabled = false;
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / 1048576).toFixed(1) + ' MB';
    }
    
    // Remove file
    removeFile.addEventListener('click', function() {
        fileInput.value = '';
        filePreview.style.display = 'none';
        dropArea.querySelector('.upload-placeholder').style.display = 'block';
        submitBtn.disabled = true;
    });
    
    // Form submission
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        if (!fileInput.files.length) {
            e.preventDefault();
            alert('Please select a video file first');
            return;
        }
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        submitBtn.disabled = true;
    });
</script>
{% endblock %}